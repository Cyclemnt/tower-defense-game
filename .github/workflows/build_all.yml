name: Build Multi-Platform Tower Defense Game

on:
  workflow_dispatch:

permissions:
  contents: write
  
jobs:

  # ----------------------------------------------------------
  # WINDOWS X64
  # ----------------------------------------------------------
  build-windows:
    name: Build Windows x64
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies (vcpkg)
        uses: lukka/run-vcpkg@v11

      - name: Configure CMake
        run: |
          cmake -B build `
            -DCMAKE_TOOLCHAIN_FILE=${{ format('{0}\vcpkg\scripts\buildsystems\vcpkg.cmake', github.workspace) }} `
            -DCMAKE_BUILD_TYPE=Release

      - name: Build
        run: cmake --build build --config Release

      - name: Prepare Release Folder
        shell: powershell
        run: |
          $PACKAGE = "${{ github.workspace }}\package-windows"
          $GAME = "$PACKAGE\game"
          $ASSETS = "$PACKAGE\assets"
          $BUILD = "${{ github.workspace }}\build\Release"

          mkdir $PACKAGE
          mkdir $GAME
          mkdir $ASSETS

          Copy-Item "$BUILD\tower_defense_cxx.exe" $GAME -Force
          Copy-Item "$BUILD\*.dll" $GAME -Force
          Copy-Item "${{ github.workspace }}\assets\*" $ASSETS -Recurse -Force

      - name: Zip Windows Release
        run: |
          powershell Compress-Archive `
            -Path package-windows\* `
            -DestinationPath tower-defense-game-windows-x64.zip

      - name: Upload Artifact (Windows)
        uses: actions/upload-artifact@v4
        with:
          name: tower-defense-game-windows-x64
          path: tower-defense-game-windows-x64.zip



  # ----------------------------------------------------------
  # LINUX X64
  # ----------------------------------------------------------
  build-linux:
    name: Build Linux x64
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt update
          sudo apt install -y \
            ninja-build \
            build-essential \
            libgl1-mesa-dev \
            mesa-common-dev \
            libudev-dev \
            libfreetype-dev \
            libopenal-dev \
            libflac-dev \
            libvorbis-dev \
            libx11-dev \
            libxrandr-dev \
            libxi-dev \
            libxinerama-dev \
            libxcursor-dev \
            libgtk-3-dev

      - name: Install vcpkg
        uses: lukka/run-vcpkg@v11

      - name: Configure CMake
        run: |
          cmake -B build \
            -G Ninja \
            -DCMAKE_TOOLCHAIN_FILE=${{ github.workspace }}/vcpkg/scripts/buildsystems/vcpkg.cmake \
            -DCMAKE_BUILD_TYPE=Release

      - name: Build
        run: cmake --build build --config Release

      - name: Prepare Release Folder
        run: |
          mkdir package-linux
          mkdir package-linux/game
          mkdir package-linux/assets

          cp build/tower_defense_cxx package-linux/game/
          cp build/*.so package-linux/game/ 2>/dev/null || true
          cp -r assets/* package-linux/assets/

      - name: Tar Linux Release
        run: |
          tar -czvf tower-defense-game-linux-x64.tar.gz package-linux

      - name: Upload Artifact (Linux)
        uses: actions/upload-artifact@v4
        with:
          name: tower-defense-game-linux-x64
          path: tower-defense-game-linux-x64.tar.gz^



  # ----------------------------------------------------------
  # CREATE GITHUB RELEASE
  # ----------------------------------------------------------
  publish:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [build-windows, build-linux]
  
    steps:
      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
  
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          name: "Tower Defense Game Release ${{ format('1.{0}', github.run_number) }}"
          tag_name: "v1.${{ github.run_number }}"
          files: |
            artifacts/tower-defense-game-windows-x64/tower-defense-game-windows-x64.zip
            artifacts/tower-defense-game-linux-x64/tower-defense-game-linux-x64.tar.gz
